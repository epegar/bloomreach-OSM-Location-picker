<!DOCTYPE HTML>
<html>
    <meta charset="utf-8">
  <head>
    <title>OpenLayers Demo</title>
    <style type="text/css">
        .flex-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: 80%;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        #map {
            width: 70%;
            height: 100%;
            margin: 0;
        }
        #searchBar {
            width: 30%;
            height: 100%;
            margin: 0;
        }
    </style>
    <!--<script src="./js/openlayers/ol.js"></script>-->
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.1.0/build/ol.js"></script>
    <script>
        var initialPosition= {
            latitude: 52.3593827,
            longitude: 4.8994339
        };
        
        var places = [];
        
        var currentPlace = {};
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            initialPosition.latitude = position.coords.latitude;
            initialPosition.longitude = position.coords.longitude;
        }
        
        function searchByAddress(event) {
            event.preventDefault();
            var inputField = document.getElementById("searchTerm");
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    places = JSON.parse(xhttp.responseText);
                    var suggestionsList = document.getElementById("suggestions");
                    suggestionsList.innerHTML = ""
                    places.forEach(function(place, index) {
                        var element = document.createElement("li");
                        element.innerHTML = place.display_name;
                        element.addEventListener("click", function() {updatePosition(place);}, false);
                        suggestionsList.append(element);
                        });
                }
            };
            xhttp.open("GET", "https://nominatim.openstreetmap.org/search/" + inputField.value + "?format=json", true);
            xhttp.send();
        }
        
        function searchByCoordinates(coordinates) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    place = JSON.parse(xhttp.responseText);
                    updatePosition(place);
                }
            };
            xhttp.open("GET", "https://nominatim.openstreetmap.org/reverse?lat=" + coordinates[1] + "&lon=" + coordinates[0] + "&format=json", true);
            xhttp.send();
        }
        
        function updatePosition(place) {
            currentPlace = place;
            var data = document.getElementById("data");
            data.innerHTML = JSON.stringify(place);
            var newPos = new ol.proj.fromLonLat([place.lon,place.lat]);
            map.getView().setCenter(newPos);
            var marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([place.lon,place.lat])),
                name: 'Current Marker'
            });
            map.getLayers().array_[1].setSource(new ol.source.Vector({
                            features: [marker]
                        }));
        }
    
        function init() {
            getLocation();
            
            var attribution = new ol.control.Attribution({
                collapsible: false
            });
            
            var raster = new ol.layer.Tile({
                source: new ol.source.OSM()
            });
            
            var markers = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: []
                }),
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    src: 'https://openlayers.org/en/latest/examples/data/icon.png'
                    })
                })
             });
            
            map = new ol.Map({
                controls: ol.control.defaults({attribution: false}).extend([attribution]),
                target: 'map',
                layers: [raster, markers],
                view: new ol.View({
                    center: ol.proj.fromLonLat([initialPosition.longitude, initialPosition.latitude]),
                    zoom: 15
                })
            });
            
            //add click listener
            map.on('singleclick', function(e) {
                //transform from the map system to the decimal longitude-latitude system
                var coordinates = ol.proj.transform(e.coordinate, 'EPSG:3857', 'EPSG:4326');
                searchByCoordinates(coordinates);
            });
        }
    </script>
  </head>
  <body onload="init();">
    <div class="flex-container">
        <div id="searchBar">
            <form id="searchform" onsubmit="searchByAddress(event)">
                <input id="searchTerm" />
            </form>
            <ul id="suggestions"></ul>
        </div>
        <div id="map"></div>
    </div>
    <div id="data"></div>
  </body>
</html>
